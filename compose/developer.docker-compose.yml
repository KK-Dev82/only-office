services:
  onlyoffice-documentserver:
    image: onlyoffice/documentserver-de:latest
    container_name: onlyoffice-docs-developer
    restart: unless-stopped
    platform: ${DOCKER_PLATFORM:-linux/arm64}
    extra_hosts:
      # ให้ container เข้าถึง host ด้วยชื่อ host.docker.internal (สำหรับ Colima/บาง environment)
      - "host.docker.internal:host-gateway"
    ports:
      - "${OO_HTTP_PORT:-8082}:80"
    environment:
      JWT_ENABLED: ${JWT_ENABLED:-true}
      JWT_SECRET: ${JWT_SECRET:-change_me_super_secret}
    volumes:
      # Persist data/logs (recommended)
      - onlyoffice_data:/var/www/onlyoffice/Data
      - onlyoffice_logs:/var/log/onlyoffice

      # --- Custom Fonts (TH Sarabun New) ---
      - ../THSarabunNew:/usr/share/fonts/truetype/th-sarabun:ro

      # --- Plugin sources (we will copy into sdkjs-plugins on start) ---
      - ../onlyoffice-plugins:/opt/kk-plugins-src:ro

      # --- Thai dictionary sources (we will copy into dictionaries on start) ---
      - ../dict:/opt/kk-dict-src:ro
      # --- Thai dictionary (Hunspell) mounted into DocumentServer dictionaries ---
      # NOTE: In documentserver-de image, /var/www/onlyoffice/documentserver/dictionaries is effectively read-only.
      #       Bind-mounting enables Thai spellcheck underline to work.
      - ../dict/th_TH:/var/www/onlyoffice/documentserver/dictionaries/th_TH:ro

      # --- Example files (sample.docx for /example/files/...) ---
      - ../example:/opt/kk-example-src:ro

      # --- Document Editor locale (แก้ 404 web-apps/apps/documenteditor/main/locale/th.json, en.json) ---
      - ./locale:/opt/kk-locale-src:ro

    command:
      - /bin/bash
      - -lc
      - |
        set -euo pipefail

        INIT_MARK="/var/www/onlyoffice/Data/.kk_init_done"
        if [ ! -f "$$INIT_MARK" ]; then
          echo "[KK] init: installing fonts/plugins/dicts..."

          (fc-cache -fv || true)
          (/usr/bin/documentserver-generate-allfonts.sh || true)

          DICS_DST="/var/www/onlyoffice/documentserver/dictionaries/th_TH"
          # If th_TH is bind-mounted, files will already be present. Keep copy best-effort.
          if [ ! -f "$$DICS_DST/th_TH.dic" ]; then
            (mkdir -p "$$DICS_DST" 2>/dev/null || true)
            (cp "/opt/kk-dict-src/th_TH/th_TH.dic" "$$DICS_DST/th_TH.dic" 2>/dev/null || true)
            (cp "/opt/kk-dict-src/th_TH/th_TH.aff" "$$DICS_DST/th_TH.aff" 2>/dev/null || true)
            if [ -f "/opt/kk-dict-src/th_TH/th_TH.json" ]; then
              (cp "/opt/kk-dict-src/th_TH/th_TH.json" "$$DICS_DST/th_TH.json" 2>/dev/null || true)
            else
              (printf '{ "codes": [1054] }\n' > "$$DICS_DST/th_TH.json") 2>/dev/null || true
            fi
            # Hyphenation (พจนานุกรมแยกคำ)
            if [ -f "/opt/kk-dict-src/th_TH/hyph_th_TH.dic" ]; then
              (cp "/opt/kk-dict-src/th_TH/hyph_th_TH.dic" "$$DICS_DST/hyph_th_TH.dic" 2>/dev/null || true)
            fi
          fi

          (python3 "/var/www/onlyoffice/documentserver/server/dictionaries/update.py" || true)

          date > "$$INIT_MARK"
          echo "[KK] init: done."
        else
          echo "[KK] init: already done ($$INIT_MARK)."
        fi

        # Dictionaries: sync every boot (so dict updates apply without deleting Data volume)
        # NOTE: This fixes cases where th_TH.dic is edited but never copied because INIT_MARK already exists.
        # Best-effort update dictionary registry
        (python3 "/var/www/onlyoffice/documentserver/server/dictionaries/update.py" || true)

        # Plugins: sync every boot (so updates apply without deleting Data volume)
        # IMPORTANT: ลบ default plugins ทั้งหมด และใช้เฉพาะ plugins ที่เราพัฒนา
        # ใช้ documentserver-pluginsmanager.sh (official tool) แทน find + rm
        PLUGINS_DST="/var/www/onlyoffice/documentserver/sdkjs-plugins"
        mkdir -p "$$PLUGINS_DST"
        
        # ลบ default plugins ทั้งหมดด้วย official plugin manager
        # ตรวจสอบว่าเป็น directory ที่ถูกต้องก่อนลบ (ป้องกันลบผิด)
        if [ -d "$$PLUGINS_DST" ] && [ "$$PLUGINS_DST" = "/var/www/onlyoffice/documentserver/sdkjs-plugins" ]; then
          echo "[KK] Removing default plugins using documentserver-pluginsmanager.sh..."
          # ใช้ official plugin manager เพื่อลบ default plugins
          # Default plugins: highlight code, speech input, youtube, mendeley, zotero, photo editor, ocr, translator, ai, speech, thesaurus
          if [ -x /usr/bin/documentserver-pluginsmanager.sh ]; then
            /usr/bin/documentserver-pluginsmanager.sh \
              --directory="$$PLUGINS_DST" \
              --remove="highlight code, speech input, youtube, mendeley, zotero, photo editor, ocr, translator, ai, speech, thesaurus" \
              2>&1 | grep -E "(Remove plugin|OK|Error)" || true
            echo "[KK] Plugin removal completed."
          else
            echo "[KK] Warning: documentserver-pluginsmanager.sh not found, using fallback method..."
            # Fallback: ใช้ find + rm (ถ้า plugin manager ไม่มี)
            find "$$PLUGINS_DST" -mindepth 1 -maxdepth 1 -type d ! -name "document-office" ! -name "dictionary-abbreviation" ! -name "speech-to-text" ! -name "thai-spellcheck" ! -name "thai-autocomplete" ! -name "comment-bridge" -exec sh -c 'chmod -R u+w "$$1" 2>/dev/null || true; rm -rf "$$1" 2>/dev/null || true' _ {} \; || true
            find "$$PLUGINS_DST" -maxdepth 1 -type f ! -name "*.md" -exec sh -c 'chmod u+w "$$1" 2>/dev/null || true; rm -f "$$1" 2>/dev/null || true' _ {} \; || true
          fi
        fi
        
        # Copy plugins ที่เราพัฒนา
        if [ -d "/opt/kk-plugins-src" ]; then
          echo "[KK] syncing custom plugins from /opt/kk-plugins-src to $$PLUGINS_DST..."
          cp -R /opt/kk-plugins-src/* "$$PLUGINS_DST"/
          # ตั้ง permission ให้ถูกต้อง
          chown -R ds:ds "$$PLUGINS_DST"/document-office "$$PLUGINS_DST"/dictionary-abbreviation "$$PLUGINS_DST"/speech-to-text "$$PLUGINS_DST"/thai-spellcheck "$$PLUGINS_DST"/thai-autocomplete "$$PLUGINS_DST"/comment-bridge 2>/dev/null || true
          chmod -R a+rX "$$PLUGINS_DST"/document-office "$$PLUGINS_DST"/dictionary-abbreviation "$$PLUGINS_DST"/speech-to-text "$$PLUGINS_DST"/thai-spellcheck "$$PLUGINS_DST"/thai-autocomplete "$$PLUGINS_DST"/comment-bridge 2>/dev/null || true
        fi

        # Example files: ensure /example/files/sample.docx exists (idempotent; safe every boot)
        EXAMPLE_DST="/var/www/onlyoffice/documentserver-example/example/files"
        mkdir -p "$$EXAMPLE_DST"
        if [ -d "/opt/kk-example-src/files" ]; then
          cp -R /opt/kk-example-src/files/* "$$EXAMPLE_DST"/ 2>/dev/null || true
        fi

        # Locale: copy en.json / th.json เพื่อแก้ 404 web-apps/apps/documenteditor/main/locale/* (ภาษาไทย)
        # URL ที่ขอเป็นแบบ /9.2.1-<hash>/web-apps/apps/documenteditor/main/locale/th.json
        if [ -d "/opt/kk-locale-src" ]; then
          sync_locale_to() {
            local d="$$1"
            [ -n "$$d" ] || return 0
            mkdir -p "$$d"
            for f in /opt/kk-locale-src/*.json; do
              [ -f "$$f" ] && cp "$$f" "$$d/" 2>/dev/null || true
            done
          }
          # 1) find ทุกโฟลเดอร์ documenteditor/main/locale
          for LOCALE_DST in $(find /var/www/onlyoffice/documentserver -type d -path "*/documenteditor/main/locale" 2>/dev/null); do
            sync_locale_to "$$LOCALE_DST"
          done
          # 2) รองรับ path แบบมีเวอร์ชัน: documentserver/9.2.1-xxx/web-apps/apps/documenteditor/main/locale
          for vdir in /var/www/onlyoffice/documentserver/[0-9]*; do
            [ -d "$$vdir" ] || continue
            LOCALE_DST="$$vdir/web-apps/apps/documenteditor/main/locale"
            sync_locale_to "$$LOCALE_DST"
          done
          # 3) fallback: path ไม่มีเวอร์ชัน
          sync_locale_to "/var/www/onlyoffice/documentserver/web-apps/apps/documenteditor/main/locale"
          echo "[KK] Locale (documenteditor/main/locale) synced."
        fi

        if [ -x /app/run-document-server.sh ]; then
          exec /app/run-document-server.sh
        elif [ -x /run-document-server.sh ]; then
          exec /run-document-server.sh
        elif command -v run-document-server.sh >/dev/null 2>&1; then
          exec run-document-server.sh
        else
          echo "Cannot find run-document-server.sh" >&2
          exit 1
        fi

volumes:
  onlyoffice_data:
  onlyoffice_logs:

